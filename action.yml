#------------------------------------------------------------------------------
#
# see
#  - https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions
#  - https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
#  - https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
#------------------------------------------------------------------------------
name: '"Tutor Build openedx" Action For GitHub Actions'
description: 'Use Tutor to build a Docker container of openedx, and upload to AWS ECR'
branding:
  icon: 'cloud'
  color: 'orange'
inputs:
  aws-ecr-repository:
    description: 'The name of the repository inside your AWS Elastic Container Registry (ECR) in which the newly created container will be uploaded and tagged. Defaults to "openedx"'
    required: false
    default: 'openedx'
  custom-theme-repository:
    description: 'URL for the Open edX custom theme to use for this build'
    required: false
    default: 'lpm0073/edx.custom-theme'
  custom-theme-repository-ref:
    description: 'branch or release of the Open edX custom theme'
    required: false
    default: 'master'
  custom-plugin-repository:
    description: 'URL for the Open edX custom plugin to use for this build'
    required: false
    default: 'lpm0073/openedx-plugin-example'
  custom-plugin-repository-ref:
    description: 'branch or release of the Open edX custom plugin'
    required: false
    default: 'main'
  custom-xblock-repository:
    description: 'Repository anme of the additional XBlock repository to install for this build'
    required: false
    default: 'edx-ora2'
  custom-xblock-repository-organization:
    description: 'the Github organization containing the XBlock repository to install for this build'
    required: false
    default: 'openedx'
  custom-xblock-repository-ref:
    description: 'branch or release of the XBlock repository'
    required: false
    default: 'master'
outputs:
  docker-container-url:
    description: 'The URL of the AWS ECR Docker container that was created and uploaded'
    value: ${{ steps.docker-image.outputs.uri }}
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v2

    - name: Setup environment
      run: |
        echo "AWS_ECR_REPOSITORY=${{ inputs.aws-ecr-repository }}" >> ${{ github.env }}
      shell: bash

    - name: Set up Docker Buildx
      id: setup-docker
      uses: docker/setup-buildx-action@v1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Create the AWS ECR repository
      id: create-repository
      uses: openedx-actions/aws-ecr-create@v0.0.2
      with:
        aws-ecr-repository: ${{ inputs.aws-ecr-repository }}

    - name: Intialize environment variables
      id: init-env
      run: |
        echo "AWS_ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> ${{ github.env }}
      shell: bash

    - name: Install Tutor
      id: install-tutor
      run: ${{ github.action_path }}/scripts/install-tutor.sh
      shell: bash

    - name: Render Tutor Config
      id: tutor-config-save
      run: tutor config save --set DOCKER_IMAGE_OPENEDX=${ECR_REGISTRY}/${ECR_REPOSITORY}:${REPOSITORY_TAG}
      shell: bash

    - name: Set Tutor Root in the Workspace
      run: |
        echo "REPOSITORY_TAG=$TUTOR_VERSION-$(date +%Y%m%d%H%M)" >> ${{ github.env }}
        echo "THEMES_PATH=$(tutor config printroot)/env/build/openedx/themes" >> ${{ github.env }}
        echo "PLUGINS_PATH=$(tutor config printroot)/env/build/openedx/requirements/" >> ${{ github.env }}
        echo "PLUGIN_REPO={{ inputs.custom-plugin-repository }}" >> ${{ github.env }}
        echo "PLUGIN_REPO_REF={{ inputs.custom-plugin-repository-ref }}" >> ${{ github.env }}
        echo "THEME_REPO={{ inputs.custom-theme-repository }}" >> ${{ github.env }}
        echo "THEME_REPO_REF={{ inputs.custom-theme-repository-ref }}" >> ${{ github.env }}
        echo "XBLOCK_NAME={{ inputs.custom-xblock-repository }}" >> ${{ github.env }}
        echo "XBLOCK_REPO={{ inputs.custom-xblock-repository-organization }}/{{ inputs.custom-xblock-repository }}" >> ${{ github.env }}

        echo "custom-theme-repository={{ inputs.custom-theme-repository }}"
        echo "AWS_ECR_REGISTRY=$AWS_ECR_REGISTRY"
        echo "AWS_ECR_REGISTRY=${AWS_ECR_REGISTRY}"
        echo "ECR_REPOSITORY=${ECR_REPOSITORY}"
        echo "REPOSITORY_TAG=${REPOSITORY_TAG}"
        echo "THEMES_PATH=${THEMES_PATH}"
        echo "PLUGINS_PATH=${PLUGINS_PATH}"
        echo "REPOSITORY_TAG=$REPOSITORY_TAG"
        echo "THEMES_PATH=$THEMES_PATH"
        echo "PLUGINS_PATH=$PLUGINS_PATH"
        echo "PLUGIN_REPO=$PLUGIN_REPO"
        echo "PLUGIN_REPO_REF=$PLUGIN_REPO_REF"
        echo "THEME_REPO=$THEME_REPO"
        echo "THEME_REPO_REF=$THEME_REPO_REF"
        echo "XBLOCK_NAME=$XBLOCK_NAME"
        echo "XBLOCK_REPO=$XBLOCK_REPO"

      shell: bash

    - name: Checkout custom theme repo
      uses: actions/checkout@v2
      with:
        repository: ${THEME_REPO}
        path: ${THEMES_PATH}/custom-edx-theme
        token: ${{ github.token }}
        ref: ${THEME_REPO_REF}

    - name: Checkout custom edx plugin repo
      uses: actions/checkout@v2
      with:
        repository: ${PLUGIN_REPO}
        path: ${PLUGINS_PATH}/custom-edx-plugin
        token: ${{ github.token }}
        ref: ${PLUGIN_REPO_REF}

    - name: Checkout xblock repo
      uses: actions/checkout@v2
      with:
        repository: ${XBLOCK_REPO}
        path: ${PLUGINS_PATH}/${XBLOCK_NAME}
        token: ${{ github.token }}
        ref: ${THEME_REPO_REF}

    - name: Add private.txt requirements
      id: add-requirements
      run: ${{ github.action_path }}/scripts/add-requirements.sh
      shell: bash

    - name: Build the image
      id: tutor-build-image
      run: tutor images build openedx
      shell: bash

    - name: Push the image
      id: docker-push-image
      run: ${{ github.action_path }}/scripts/upload-to-aws-ecr.sh
      shell: bash

    - name: Docker image:tag
      id: docker-image
      run: |
        echo "DOCKER_IMAGE=${{ inputs.aws-ecr-registry }}/${{ inputs.aws-ecr-repository }}:${REPOSITORY_TAG}" >> ${{ github.env }}
        echo "::set-output name=uri::$(echo $DOCKER_IMAGE)"
      shell: bash
